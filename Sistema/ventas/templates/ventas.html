{% extends "base.html" %}
{% load static %}
{% load django_bootstrap5 %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="h3 mb-4 text-gray-800">
        <i class="fas fa-cash-register mr-2"></i>Registro de Ventas
    </h1>
    
    {% if not caja %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle mr-2"></i> No hay una caja abierta para este usuario. Debe abrir una caja antes de realizar ventas.
        <a href="{% url 'apertura_caja' %}" class="btn btn-primary ml-3">
            <i class="fas fa-door-open mr-1"></i> Abrir Caja
        </a>
    </div>
    {% else %}
    
    <!-- Buscador de productos -->
    <div class="input-group my-3">
        <input type="text" id="buscarProducto" class="form-control" placeholder="Buscar producto...">
        <div class="input-group-append">
            <span class="input-group-text bg-white">
                <i class="fas fa-search text-primary"></i>
            </span>
        </div>
    </div>
    
    <!-- Lista de productos con scroll -->
    <div id="lista-productos" class="list-group mb-4" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 5px;">
        {% for producto in productos %}
        <div class="list-group-item d-flex justify-content-between align-items-center producto-item">
            <span><strong>{{ producto.Nombre }}</strong> - ${{ producto.PrecioDeContado|floatformat:2 }}</span>
            <button type="button" class="btn btn-sm btn-primary" 
                    onclick="agregarProductoManual({{ producto.id }}, '{{ producto.Nombre }}', {{ producto.PrecioDeContado }}, {{ producto.Cantidad }})">
                <i class="fas fa-plus-circle"></i> Agregar
            </button>
        </div>
        {% endfor %}
    </div>
    
    <div class="row">
        <!-- Tabla de productos agregados -->
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-shopping-cart mr-2"></i>Productos Seleccionados
                    </h6>
                </div>
                <div class="card-body">
                    <form id="formVenta" action="{% url 'ventas' %}" method="post">
                        {% csrf_token %}
                        <div id="productosSeleccionados">
                            <!-- Aquí se agregarán los inputs hidden con los productos seleccionados -->
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered" id="tablaCarrito">
                                <thead class="thead-dark">
                                    <tr class="text-center">
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                        <th>Precio</th>
                                        <th>Subtotal</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Aquí se agregarán los productos seleccionados -->
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Panel derecho: Total y medio de pago -->
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-cash-register mr-2"></i>Resumen de Venta
                    </h6>
                </div>
                <div class="card-body">
                    <h4 class="font-weight-bold">Total: <span id="totalVenta" class="float-right">$0.00</span></h4>
                    
                    <hr>
                    
                    <div class="form-group">
                        <label for="medio_pago_id"><strong>Medio de Pago:</strong></label>
                        <select id="medio_pago_id" name="medio_pago_id" class="form-control">
                            <option value="">Seleccione un medio de pago</option>
                            {% for medio in medios_pago %}
                            <option value="{{ medio.id }}">{{ medio.Nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button id="btnFinalizarVenta" class="btn btn-success btn-block mt-4" disabled>
                        <i class="fas fa-check-circle mr-2"></i>Finalizar Venta
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Script directo en el contenido -->
<script>
    // Variables globales
    let productos = [];
    let total = 0;
    
    // Función para agregar producto manualmente
    function agregarProductoManual(id, nombre, precio, stock) {
        console.log("Función agregarProductoManual llamada:", id, nombre, precio, stock);
        
        // Verificar si ya existe en el carrito
        let existe = false;
        
        for (let i = 0; i < productos.length; i++) {
            if (productos[i].id === id) {
                existe = true;
                if (productos[i].cantidad < stock) {
                    productos[i].cantidad++;
                    productos[i].subtotal = productos[i].cantidad * precio;
                } else {
                    console.log('No hay suficiente stock disponible');
                }
                break;
            }
        }
        
        if (!existe) {
            productos.push({
                id: id,
                nombre: nombre,
                precio: precio,
                cantidad: 1,
                subtotal: precio
            });
            console.log("Producto agregado:", nombre);
        }
        
        actualizarCarrito();
    }
    
    // Actualizar carrito
    function actualizarCarrito() {
        let html = '';
        let inputsHidden = '';
        total = 0;
        
        console.log("Actualizando carrito con", productos.length, "productos");
        
        for (let i = 0; i < productos.length; i++) {
            let item = productos[i];
            html += `
                <tr data-index="${i}">
                    <td>${item.nombre}</td>
                    <td class="text-center">
                        <div class="d-flex align-items-center justify-content-center">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="modificarCantidad(${i}, -1)">➖</button>
                            <input type="number" value="${item.cantidad}" min="1" class="form-control form-control-sm text-center mx-1" style="width: 60px;" onchange="actualizarCantidadManual(this, ${i})">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="modificarCantidad(${i}, 1)">➕</button>
                        </div>
                    </td>
                    <td>
                        <input type="number" value="${item.precio.toFixed(2)}" min="0" class="form-control form-control-sm precio-input" onchange="actualizarPrecio(this, ${i})">
                    </td>
                    <td class="text-right subtotal">$${item.subtotal.toFixed(2)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-danger" onclick="eliminarProducto(${i})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            inputsHidden += `
                <input type="hidden" name="productos_ids" value="${item.id}">
                <input type="hidden" name="cantidades" value="${item.cantidad}">
                <input type="hidden" name="precios" value="${item.precio}">
            `;
            
            total += item.subtotal;
        }
        
        document.querySelector('#tablaCarrito tbody').innerHTML = html;
        document.getElementById('totalVenta').textContent = '$' + total.toFixed(2);
        document.getElementById('productosSeleccionados').innerHTML = inputsHidden;
        
        // Habilitar/deshabilitar botón finalizar
        document.getElementById('btnFinalizarVenta').disabled = (productos.length === 0);
    }
    
    // Modificar cantidad
    function modificarCantidad(index, cambio) {
        if (index >= 0 && index < productos.length) {
            let nuevaCantidad = productos[index].cantidad + cambio;
            if (nuevaCantidad > 0) {
                productos[index].cantidad = nuevaCantidad;
                productos[index].subtotal = productos[index].cantidad * productos[index].precio;
                actualizarCarrito();
            }
        }
    }
    
    // Actualizar cantidad manualmente
    function actualizarCantidadManual(input, index) {
        const nuevaCantidad = parseInt(input.value);
        if (nuevaCantidad > 0 && index >= 0 && index < productos.length) {
            productos[index].cantidad = nuevaCantidad;
            productos[index].subtotal = productos[index].cantidad * productos[index].precio;
            actualizarCarrito();
        }
    }
    
    // Actualizar precio
    function actualizarPrecio(input, index) {
        const nuevoPrecio = parseFloat(input.value);
        if (nuevoPrecio >= 0 && index >= 0 && index < productos.length) {
            productos[index].precio = nuevoPrecio;
            productos[index].subtotal = productos[index].cantidad * productos[index].precio;
            actualizarCarrito();
        }
    }
    
    // Eliminar producto
    function eliminarProducto(index) {
        if (index >= 0 && index < productos.length) {
            productos.splice(index, 1);
            actualizarCarrito();
        }
    }
    
    // Cuando el documento esté listo
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Documento listo (JavaScript puro)");
        
        // Buscar productos en tiempo real
        document.getElementById('buscarProducto').addEventListener('keyup', function() {
            const valor = this.value.toLowerCase();
            console.log("Buscando:", valor);
            
            const items = document.querySelectorAll('#lista-productos .producto-item');
            items.forEach(function(item) {
                const texto = item.textContent.toLowerCase();
                item.style.display = texto.includes(valor) ? '' : 'none';
            });
        });
        
        // Finalizar venta
        document.getElementById('btnFinalizarVenta').addEventListener('click', function() {
            if (productos.length === 0) {
                alert('Debe agregar al menos un producto a la venta');
                return;
            }
            
            const medioPago = document.getElementById('medio_pago_id').value;
            if (!medioPago) {
                alert('Debe seleccionar un medio de pago');
                return;
            }
            
            document.getElementById('formVenta').submit();
        });
    });
</script>

{% endblock %}
