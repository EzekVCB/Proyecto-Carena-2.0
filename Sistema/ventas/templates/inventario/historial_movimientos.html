{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Historial de Movimientos - {{ producto.Nombre }}</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalAjuste">
                            Realizar Ajuste
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Información del Producto -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <strong>Stock Actual:</strong> {{ producto.Cantidad }}
                        </div>
                        <div class="col-md-3">
                            <strong>Stock Mínimo:</strong> {{ producto.CantidadMinimaSugerida }}
                        </div>
                        <div class="col-md-3">
                            <strong>Última Modificación:</strong> {{ producto.FechaUltimaModificacion }}
                        </div>
                        <div class="col-md-3">
                            <strong>Estado:</strong> {{ producto.estado_stock }}
                        </div>
                    </div>

                    <!-- Tabla de Movimientos -->
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Origen</th>
                                <th>Cantidad</th>
                                <th>Stock Anterior</th>
                                <th>Stock Nuevo</th>
                                <th>Referencia</th>
                                <th>Usuario</th>
                                <th>Observación</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for movimiento in movimientos %}
                            <tr>
                                <td>{{ movimiento.fecha|date:"d/m/Y H:i" }}</td>
                                <td>{{ movimiento.get_tipo_movimiento_display }}</td>
                                <td>{{ movimiento.get_origen_movimiento_display }}</td>
                                <td>{{ movimiento.cantidad }}</td>
                                <td>{{ movimiento.stock_anterior }}</td>
                                <td>{{ movimiento.stock_nuevo }}</td>
                                <td>{{ movimiento.documento_referencia }}</td>
                                <td>{{ movimiento.usuario }}</td>
                                <td>{{ movimiento.observacion|default:"-" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center">No hay movimientos registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Ajuste -->
<div class="modal fade" id="modalAjuste" tabindex="-1" role="dialog" aria-labelledby="modalAjusteLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAjusteLabel">Ajuste de Inventario</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'ajuste_inventario' producto.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="id_tipo_ajuste">Tipo de Ajuste</label>
                        {{ form.tipo_ajuste }}
                    </div>
                    <div class="form-group">
                        <label for="id_cantidad">Cantidad</label>
                        {{ form.cantidad }}
                    </div>
                    <div class="form-group">
                        <label for="id_justificacion">Justificación</label>
                        {{ form.justificacion }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Ajuste</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Inicializar DataTable
        $('.table').DataTable({
            "order": [[0, "desc"]],  // Ordenar por fecha descendente
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
            }
        });
    });
</script>
{% endblock %} 